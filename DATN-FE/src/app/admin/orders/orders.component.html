<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Quản lý Đơn hàng</h2>
        <button class="btn btn-primary" (click)="loadOrders()" [disabled]="loading">
            <span *ngIf="loading" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            {{ loading ? 'Đang tải...' : 'Làm mới' }}
        </button>
    </div>

    <!-- Error Message -->
    <div *ngIf="errorMessage" class="alert alert-danger">
        {{ errorMessage }}
    </div>

    <!-- Orders Table -->
    <div class="card">
        <div class="card-body">
            <div *ngIf="!loading && orders.length === 0" class="text-center p-4">
                <p>Không có đơn hàng nào để hiển thị.</p>
            </div>

            <div class="table-responsive" *ngIf="orders.length > 0">
                <table class="table table-striped table-hover align-middle">
                    <thead>
                        <tr>
                            <th scope="col">Mã Đơn</th>
                            <th scope="col">Khách hàng</th>
                            <th scope="col">Tổng tiền</th>
                            <th scope="col">Ngày đặt</th>
                            <th scope="col">TT Đơn hàng</th>
                            <th scope="col">TT Giao Hàng</th>
                            <th scope="col">Thanh Toán</th>
                            <th scope="col" class="text-center">Hành động</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let order of orders">
                            <th scope="row">#{{ order.id }}</th>
                            <td>
                                <div>{{ order.receiverName }}</div>
                                <small class="text-muted">{{ order.phoneNumber }}</small>
                            </td>
                            <td>{{ order.totalPrice | number:'1.0-0' }} đ</td>
                            <td>{{ order.created_At | date:'dd/MM/yyyy HH:mm' }}</td>
                            <td>
                                <select class="form-select form-select-sm" [value]="order.orderStatus"
                                    (change)="onStatusChange(order.id, $event)">
                                    <option *ngFor="let status of orderStatuses" [value]="status" 
                                            [ngClass]="getStatusClass(status)">
                                        {{ getStatusText(status) }}
                                    </option>
                                </select>
                            </td>
                            <td>
                                <select *ngIf="order.shippingStatus" class="form-select form-select-sm" [value]="order.shippingStatus"
                                    (change)="onShippingStatusChange(order.id, $event)">
                                    <option *ngFor="let status of shippingStatuses" [value]="status"
                                            [ngClass]="getShippingStatusClass(status)">
                                        {{ getShippingStatusText(status) }}
                                    </option>
                                </select>
                                <span *ngIf="!order.shippingStatus" class="text-muted">N/A</span>
                            </td>
                            <td>
                                <span class="badge" [ngClass]="getPaymentStatusClass(order.paymentMethod as any)">
                                    {{ getPaymentStatusText(order.paymentMethod as any) }}
                                </span>
                            </td>
                            <td class="text-center">
                                <button class="btn btn-sm btn-info" (click)="showOrderDetails(order)">Xem</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Order Detail Modal -->
<div class="modal-overlay" *ngIf="selectedOrderForDetail">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chi tiết Đơn hàng: #{{ selectedOrderForDetail.id }}</h5>
                <button type="button" class="btn-close" (click)="closeDetailsModal()"></button>
            </div>
            <div class="modal-body">
                <h6>Sản phẩm trong đơn hàng:</h6>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Sản phẩm</th>
                            <th>SKU</th>
                            <th>Số lượng</th>
                            <th>Đơn giá</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let item of selectedOrderForDetail.items">
                            <td>{{ item.productName }}</td>
                            <td>{{ item.sku }}</td>
                            <td>{{ item.quantity }}</td>
                            <td>{{ item.price | number:'1.0-0' }} đ</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" (click)="closeDetailsModal()">Đóng</button>
            </div>
        </div>
    </div>
</div>