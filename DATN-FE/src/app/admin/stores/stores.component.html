<div class="container mt-4">
  <h2>Quản lý Cửa hàng</h2>

  <!-- Add/Edit Form -->
  <div *ngIf="showForm" class="card my-4">
    <div class="card-body">
      <h5 class="card-title">{{ selectedStore.id ? 'Chỉnh sửa Cửa hàng' : 'Thêm Cửa hàng mới' }}</h5>
      <form (ngSubmit)="saveStore()">
        <div class="mb-3">
          <label for="storeName" class="form-label">Tên cửa hàng</label>
          <input type="text" class="form-control" id="storeName" [(ngModel)]="selectedStore.name" name="name" required>
        </div>

        <!-- Location Dropdowns -->
        <div class="row">
          <div class="col-md-4 mb-3">
            <label class="form-label">Tỉnh/Thành phố</label>
            <app-searchable-dropdown [data]="ghnProvinces" displayField="ProvinceName"
              [searchFields]="provinceSearchFields" placeholder="Tìm tỉnh/thành phố..."
              (selectionChange)="onGhnProvinceSelect($event)">
            </app-searchable-dropdown>
          </div>
          <div class="col-md-4 mb-3">
            <label class="form-label">Quận/Huyện</label>
            <app-searchable-dropdown [data]="ghnDistricts" displayField="DistrictName"
              [searchFields]="districtSearchFields" placeholder="Tìm quận/huyện..."
              (selectionChange)="onGhnDistrictSelect($event)">
            </app-searchable-dropdown>
          </div>
          <div class="col-md-4 mb-3">
            <label class="form-label">Phường/Xã</label>
            <app-searchable-dropdown [data]="ghnWards" displayField="WardName" [searchFields]="wardSearchFields"
              placeholder="Tìm phường/xã..." (selectionChange)="onGhnWardSelect($event)">
            </app-searchable-dropdown>
          </div>
        </div>

        <div class="mb-3">
          <label for="storeAddressDetail" class="form-label">Địa chỉ chi tiết (Số nhà, tên đường)</label>
          <input type="text" class="form-control" id="storeAddressDetail" [(ngModel)]="selectedStore.addressDetail"
            name="addressDetail">
        </div>

        <div class="mb-3">
          <label for="storePhone" class="form-label">Số điện thoại</label>
          <input type="text" class="form-control" id="storePhone" [(ngModel)]="selectedStore.phoneNumber"
            name="phoneNumber">
        </div>
        <div class="mb-3 form-check">
          <input type="checkbox" class="form-check-input" id="storeActive" [(ngModel)]="selectedStore.active"
            name="active">
          <label class="form-check-label" for="storeActive">Hoạt động</label>
        </div>
        <button type="submit" class="btn btn-primary me-2">Lưu</button>
        <button type="button" class="btn btn-secondary" (click)="resetForm()">Hủy</button>
      </form>
    </div>
  </div>

  <!-- Action Buttons for adding stores -->
  <div *ngIf="!showForm && !showGhnForm" class="mb-3">
    <button class="btn btn-success" (click)="showAddForm()">Thêm Cửa hàng thủ công</button>
    <button class="btn btn-info ms-2" (click)="showGhnAddForm()">Thêm cửa hàng từ GHN</button>
  </div>

  <!-- GHN Store Search Form -->
  <div *ngIf="showGhnForm" class="card my-4">
    <div class="card-body">
      <h5 class="card-title">Tìm và Thêm Cửa hàng từ Giao Hàng Nhanh (GHN)</h5>
      <p>Chọn Tỉnh/Thành và Quận/Huyện để tìm kiếm cửa hàng có sẵn trên hệ thống GHN.</p>
      <form (ngSubmit)="searchGhnStores()">
        <div class="row">
          <div class="col-md-4 mb-3">
            <label class="form-label">Tỉnh/Thành phố</label>
            <app-searchable-dropdown [data]="ghnProvinces" displayField="ProvinceName"
              [searchFields]="provinceSearchFields" placeholder="Tìm tỉnh/thành phố..."
              (selectionChange)="onGhnProvinceSelect($event)">
            </app-searchable-dropdown>
          </div>
          <div class="col-md-4 mb-3">
            <label class="form-label">Quận/Huyện</label>
            <app-searchable-dropdown [data]="ghnDistricts" displayField="DistrictName"
              [searchFields]="districtSearchFields" placeholder="Tìm quận/huyện..."
              (selectionChange)="onGhnDistrictSelect($event)">
            </app-searchable-dropdown>
          </div>
          <div class="col-md-4 mb-3">
            <label class="form-label">Phường/Xã</label>
            <app-searchable-dropdown [data]="ghnWards" displayField="WardName" [searchFields]="wardSearchFields"
              placeholder="Tìm phường/xã..." (selectionChange)="onGhnWardSelect($event)">
            </app-searchable-dropdown>
          </div>
        </div>
        <button type="submit" class="btn btn-primary me-2" [disabled]="!ghnSelectedDistrictId">Tìm kiếm</button>
        <button type="button" class="btn btn-secondary" (click)="hideGhnForm()">Hủy</button>
      </form>
    </div>

    <!-- GHN Stores Result Table -->
    <div *ngIf="ghnStoresResult && ghnStoresResult.length > 0" class="card-body border-top">
      <h5 class="card-title mt-3">Kết quả tìm kiếm</h5>
      <p>Chọn một cửa hàng để thêm vào hệ thống của bạn.</p>
      <div class="table-responsive">
        <table class="table table-striped">
          <thead>
            <tr>
              <th scope="col">ID (GHN)</th>
              <th scope="col">Tên cửa hàng</th>
              <th scope="col">Địa chỉ</th>
              <th scope="col">Điện thoại</th>
              <th scope="col">Hành động</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let store of ghnStoresResult">
              <th scope="row">{{ store._id }}</th>
              <td>{{ store.name }}</td>
              <td>{{ store.address }}</td>
              <td>{{ store.phone }}</td>
              <td>
                <button class="btn btn-sm btn-success" (click)="addGhnStore(store)">Thêm</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <div *ngIf="searchedGhn && (!ghnStoresResult || ghnStoresResult.length === 0)" class="card-body border-top">
      <p class="mt-3">Không tìm thấy cửa hàng nào cho khu vực đã chọn.</p>
    </div>
  </div>

  <!-- Stores Table -->
  <table class="table table-striped">
    <thead>
      <tr>
        <th scope="col">ID</th>
        <th scope="col">Tên cửa hàng</th>
        <th scope="col">Địa chỉ</th>
        <th scope="col">Số điện thoại</th>
        <th scope="col">Hành động</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let store of stores">
        <th scope="row">{{ store.code }}</th>
        <td>{{ store.name }}</td>
        <td>{{ store.location }}</td>
        <td>{{ store.phoneNumber }}</td>
        <td>
          <button class="btn btn-sm btn-warning me-2" (click)="selectStore(store)">Sửa</button>
          <button class="btn btn-sm btn-danger" (click)="deleteStore(store.id)">Xóa</button>
        </td>
      </tr>
    </tbody>
  </table>
</div>